name: "Self-Test ‚Äì PR Auditor"

on:
  pull_request:
    paths:
      - "**/*.sol"
      - "**/*.rs"
      - "**/*.move"
      - "scripts/**"
      - "entrypoint.sh"
      - "action.yml"
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-action:
    name: "PR Auditor"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Run the AI-reviewed audit
      - name: Run PR Auditor
        uses: ./
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          severity_threshold: "low"
          fail_on_findings: "false"

      # Collect raw tool output (reuses tools already installed by the action above)
      - name: Collect Raw Slither Output
        if: always()
        continue-on-error: true
        run: |
          mkdir -p /tmp/raw-reports
          SOL_FILES=$(find . -name "*.sol" -not -path "*/node_modules/*" -not -path "*/.git/*" | head -50)
          if [ -n "$SOL_FILES" ]; then
            for f in $SOL_FILES; do
              echo "=== Scanning: $f ===" >> /tmp/raw-reports/slither-stdout.txt
              slither "$f" --json - 2>>/tmp/raw-reports/slither-stderr.txt >> /tmp/raw-reports/slither.json || true
            done
          fi

      - name: Collect Raw Aderyn Output
        if: always()
        continue-on-error: true
        run: |
          if find . -name "*.sol" -not -path "*/node_modules/*" | head -1 | grep -q .; then
            aderyn . --output /tmp/raw-reports/aderyn.md 2>&1 || true
          fi

      - name: Collect Raw cargo-audit Output
        if: always()
        continue-on-error: true
        run: |
          CARGO_TOMLS=$(find . -name "Cargo.toml" -not -path "*/target/*" -not -path "*/.git/*")
          if [ -n "$CARGO_TOMLS" ]; then
            for manifest in $CARGO_TOMLS; do
              DIR=$(dirname "$manifest")
              echo "=== Auditing: $manifest ===" >> /tmp/raw-reports/cargo-audit-log.txt
              (cd "$DIR" && cargo-audit audit --json 2>&1) >> /tmp/raw-reports/cargo-audit.json || true
            done
          fi

      # Upload raw reports as downloadable artifacts
      - name: Upload Raw Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw-tool-reports
          path: /tmp/raw-reports/
          retention-days: 30
          if-no-files-found: ignore

      # Post raw output as a second PR comment
      - name: Post Raw Output to PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '## üî¨ Raw Static Analysis Output\n\n';
            body += '*Unprocessed output from the analysis tools. See the PR Auditor comment above for the AI-reviewed summary.*\n\n';

            // Slither
            try {
              const slither = fs.readFileSync('/tmp/raw-reports/slither.json', 'utf8');
              const lines = slither.trim().split('\n').filter(l => l.trim());
              let detectorCount = 0;
              for (const line of lines) {
                try {
                  const parsed = JSON.parse(line);
                  detectorCount += (parsed.results?.detectors || []).length;
                } catch(e) {}
              }
              body += '<details>\n<summary>üêç Slither (' + detectorCount + ' detectors triggered)</summary>\n\n```json\n';
              body += slither.substring(0, 30000);
              body += '\n```\n</details>\n\n';
            } catch (e) {
              body += '**Slither:** No output or not applicable.\n\n';
            }

            // Aderyn
            try {
              const aderyn = fs.readFileSync('/tmp/raw-reports/aderyn.md', 'utf8');
              body += '<details>\n<summary>ü¶Ö Aderyn</summary>\n\n';
              body += aderyn.substring(0, 30000);
              body += '\n</details>\n\n';
            } catch (e) {
              body += '**Aderyn:** No output or not applicable.\n\n';
            }

            // cargo-audit
            try {
              const audit = fs.readFileSync('/tmp/raw-reports/cargo-audit.json', 'utf8');
              body += '<details>\n<summary>ü¶Ä cargo-audit</summary>\n\n```json\n';
              body += audit.substring(0, 30000);
              body += '\n```\n</details>\n\n';
            } catch (e) {
              body += '**cargo-audit:** No output or not applicable.\n\n';
            }

            body += '\n---\n*Generated by [PR Auditor](https://github.com/Shawnchee/the-auditor) üî¨ ‚Äî Raw Tool Output*\n';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
